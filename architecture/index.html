<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        
        <meta name="author" content="Benjamin Bengfort and Pete Keleher">
        
        <link rel="shortcut icon" href="../img/favicon.ico">

	<title>Architecture - FluidFS</title>

        <link href="../css/bootstrap-custom.min.css" rel="stylesheet">
        <link href="../css/font-awesome-4.0.3.css" rel="stylesheet">
        <link rel="stylesheet" href="../css/highlight.css">
        <link href="../css/base.css" rel="stylesheet">

        <!-- HTML5 shim and Respond.js IE8 support of HTML5 elements and media queries -->
        <!--[if lt IE 9]>
            <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
            <script src="https://oss.maxcdn.com/libs/respond.js/1.3.0/respond.min.js"></script>
        <![endif]-->

        
        <script>
            (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
            (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
            m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
            })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

            ga('create', 'UA-8096804-12', 'auto');
            ga('send', 'pageview');
        </script>
        
    </head>

    <body>

        <div class="navbar navbar-default navbar-fixed-top" role="navigation">
    <div class="container">

        <!-- Collapsed navigation -->
        <div class="navbar-header">
            <!-- Expander button -->
            <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-collapse">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </button>

            <!-- Main title -->
            <a class="navbar-brand" href="..">FluidFS</a>
        </div>

        <!-- Expanded navigation -->
        <div class="navbar-collapse collapse">
            <!-- Main navigation -->
            <ul class="nav navbar-nav">
            
            
                <li >
                    <a href="..">Introduction</a>
                </li>
            
            
            
                <li class="active">
                    <a href="./">Architecture</a>
                </li>
            
            
            
                <li class="dropdown">
                    <a href="#" class="dropdown-toggle" data-toggle="dropdown">About <b class="caret"></b></a>
                    <ul class="dropdown-menu">
                    
                        
<li >
    <a href="../about/">FluidFS</a>
</li>

                    
                        
<li >
    <a href="../changelog/">Changelog</a>
</li>

                    
                    </ul>
                </li>
            
            
            </ul>

            <!-- Search, Navigation and Repo links -->
            <ul class="nav navbar-nav navbar-right">
                <li>
                    <a href="#" data-toggle="modal" data-target="#mkdocs_search_modal">
                        <i class="fa fa-search"></i> Search
                    </a>
                </li>
                <li >
                    <a rel="next" href="..">
                        <i class="fa fa-arrow-left"></i> Previous
                    </a>
                </li>
                <li >
                    <a rel="prev" href="../about/">
                        Next <i class="fa fa-arrow-right"></i>
                    </a>
                </li>
                
                <li>
                    <a href="https://github.com/bbengfort/fluidfs">
                        
                            <i class="fa fa-github"></i>
                        
                        GitHub
                    </a>
                </li>
                
            </ul>
        </div>
    </div>
</div>

        <div class="container">
            <div class="col-md-3"><div class="bs-sidebar hidden-print affix well" role="complementary">
    <ul class="nav bs-sidenav">
    
        <li class="main active"><a href="#architecture">Architecture</a></li>
        
            <li><a href="#replication">Replication</a></li>
        
            <li><a href="#configuration">Configuration</a></li>
        
            <li><a href="#fs-interface">FS Interface</a></li>
        
            <li><a href="#underlying-storage">Underlying Storage</a></li>
        
            <li><a href="#rpc-and-communication">RPC and Communication</a></li>
        
            <li><a href="#security">Security</a></li>
        
            <li><a href="#deamonization-and-startup">Deamonization and Startup</a></li>
        
    
    </ul>
</div></div>
            <div class="col-md-9" role="main">

<h1 id="architecture">Architecture</h1>
<p><img alt="FluidFS Component Architecture" src="../img/architecture.png" /></p>
<h2 id="replication">Replication</h2>
<p>FluidFS will have three modes of operation with two primary protocols. The consistency protocols include:</p>
<ul>
<li>Basic Raft</li>
<li>Hierarchical Consensus</li>
</ul>
<p>And the modes of operation are currently:</p>
<ul>
<li>Best Effort</li>
<li>Transactions</li>
<li>Linearizeability</li>
</ul>
<p>The prototype version of FluidFS will implement the Basic Raft/Linearizeability consistency protocol and operation mode. This will allow us to set a performance baseline and to build many of the components required for a distributed file system that is coordinated by consensus.</p>
<p>This mode of operation will be implemented through <em>locking</em> decisions that are determined by consensus. Locks will eventually be replaced by <em>leases</em>, which for now we will describe as time limited locks that can be automatically renewed through a heartbeat mechanism.</p>
<h3 id="logs-and-caches">Logs and Caches</h3>
<p>Each replica will maintain a local <em>cache</em> of version information for fast lookups. This will be implemented as a key-value store where the namespace of the filesystem points to the latest local version of each entity. The replica can retrieve the version meta data by:</p>
<ul>
<li>Looking up the latest version for the entity in the cache</li>
<li>Looking up the most recent commit for the entity in the cache</li>
<li>Requesting the version for the entity from the leader</li>
</ul>
<p>In our current mode of operation, a read access will need to lock the file (unless we have read-only accesses) and detect if the file is locked or not.  </p>
<p>Consensus decisions order a log - and all replicas will contain an in-memory log of operations. The log will periodically be snapshotted to disk in order to free memory (we can perform a similar mechanism for the cache). There are open questions about how the cache and the log interact.</p>
<h3 id="version-replication">Version Replication</h3>
<p>Metadata concerning file system entities are the only objects that need replication in a consistent fashion. When consensus algorithms are used for consistency, they create a single, ordered log that will contain (for our current mode of operation):</p>
<ul>
<li>Lock grants</li>
<li>Version meta data (I propose the log only contain version numbers)</li>
<li>Lock releases</li>
</ul>
<p>On a read access (open):</p>
<ol>
<li>Read the latest version from the DB (check if locked, if so abort)</li>
<li>Request a lock from the leader (consensus occurs)</li>
<li>On lock commit, update metadata and return the file's blobs.</li>
</ol>
<p>On a write access (close):</p>
<ul>
<li>store the blobs and the write metadata into the cache (read your writes)</li>
<li>forward the remote write to the leader</li>
<li>if leader is unavailable, keep retrying</li>
<li>both version decision and lock release occur simultaneously</li>
<li>if leader rejects the write (e.g. the lock was removed before the write), mark the conflict on the file (similar to the Git method of marking merge conflicts).</li>
<li>on commit, update the local metadata</li>
</ul>
<h3 id="blob-replication">Blob Replication</h3>
<p>Smarter blob replication will be required for the future but for now:</p>
<ul>
<li>blobs are stored either in BoltDB or prefixed directories on disk</li>
<li>when blobs are written, they are replicated via anti-entropy</li>
<li>anti-entropy sessions broadcast a list of prefixes and their blob count</li>
<li>the remote returns any additional blobs since that count (pull)</li>
</ul>
<p>This will lead to full replication of all blobs, and further inspection of blob replication in the future is required.</p>
<h2 id="configuration">Configuration</h2>
<p>The system will be configured by YAML files, with increasing priority:</p>
<ul>
<li>/etc/fluid/fluid.yml</li>
<li>$HOME/.fluid/fluid.yml</li>
<li>$PWD/fluid.yml</li>
</ul>
<p>A YAML configuration can be passed in at the command line (to allow us to conduct multiple experiments), however any command line arguments will supersede any configuration in any YAML file.</p>
<p>I will also create a configuration server that returns a global configuration via JSON API. If the global_config variable is set, then on startup/reload the system will request the global configuration and <em>update the /etc/fluid/fluid.yml</em> file directly (or possibly create a global.yml file that has a slightly higher priority)!</p>
<p>Configuration will include:</p>
<ul>
<li>Replica behaviors</li>
<li>Mount points</li>
<li>Logging information</li>
<li>Database information</li>
</ul>
<p>There will also need to be a <code>remotes.yml</code> file that describes all the possible nodes in the network. This will be similarly updated by the configuration server.</p>
<p>The configuration directory will also require the following:</p>
<ul>
<li>TLS certificate</li>
<li>client key (though this might be stored in the configuration file)</li>
</ul>
<h2 id="fs-interface">FS Interface</h2>
<h3 id="fuse">FUSE</h3>
<h3 id="api">API</h3>
<h3 id="fsevents">FSEvents</h3>
<h2 id="underlying-storage">Underlying Storage</h2>
<p>We will use a combination of <a href="https://github.com/boltdb/bolt">BoltDB</a> and the local file system for underlying storage.</p>
<p>BoltDB will contain the following buckets:</p>
<ul>
<li>FS file names to latest version id</li>
<li>FS directory names to directory meta data</li>
<li>Version ID to version meta data</li>
<li>Blob ID to blob (data or path)</li>
<li>Blob state since last anti-entropy</li>
</ul>
<p>If we use the file system for blob storage we will split the blob IDs (SHA256 hashes) into subdirectories, such that the first 7 characters of the hash is the first directory, the second, the sub directory, and so on and so forth until the blob data.</p>
<h2 id="rpc-and-communication">RPC and Communication</h2>
<p>Communication will be conducted by <a href="http://www.grpc.io/">gRPC</a> and <a href="https://developers.google.com/protocol-buffers/">Protocol Buffers</a> serialization. We will take advantage of gRPC communication patterns, for example some comms will use Unary RPC (single request and response) while others will use the streaming RPC services for many messages per communication.</p>
<h3 id="remoteaccess">RemoteAccess</h3>
<p>This will be a unary rpc from a follower to the leader requesting a lock or a write/release. The leader will return the response immediately to acknowledge it is engaging in consensus decisions.</p>
<h3 id="appendentries">AppendEntries</h3>
<p>The Raft AE RPC and heartbeats.</p>
<h3 id="election">Election</h3>
<p>RPC messages for requesting votes on election timeout.</p>
<h3 id="blob-anti-entropy">Blob Anti-Entropy</h3>
<p>RPC messages for conducting pairwise anti-entropy of the blob space.</p>
<h2 id="security">Security</h2>
<p>We will secure communication over HTTP with:</p>
<ul>
<li>HAWK authentication for clients</li>
<li>TLS for transport layer security</li>
</ul>
<p>We also want to have blob encryption, but as this will require key management, we'll reserve this as a stretch goal.</p>
<h2 id="deamonization-and-startup">Deamonization and Startup</h2>
<p>I will create LaunchAgent (for OS X) and Upstart scripts so that the FluidFS daemon always runs in the background on startup etc. It will use the mount points configuration to ensure that FUSE is mounted correctly in those directories.</p></div>
        </div>

        <footer class="col-md-12">
            <hr>
            
                <center>Built at the University of Maryland, licensed by <a rel="license" href="http://creativecommons.org/licenses/by-nc-sa/4.0/"><img alt="Creative Commons License" style="border-width:0" src="https://i.creativecommons.org/l/by-nc-sa/4.0/80x15.png" /></a></center>
            
            <center>Documentation built with <a href="http://www.mkdocs.org/">MkDocs</a>.</center>
        </footer>

        <script src="../js/jquery-1.10.2.min.js"></script>
        <script src="../js/bootstrap-3.0.3.min.js"></script>
        <script src="../js/highlight.pack.js"></script>
        <script>var base_url = '..';</script>
        <script data-main="../mkdocs/js/search.js" src="../mkdocs/js/require.js"></script>
        <script src="../js/base.js"></script>

        <div class="modal" id="mkdocs_search_modal" tabindex="-1" role="dialog" aria-labelledby="Search Modal" aria-hidden="true">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>
                        <h4 class="modal-title" id="exampleModalLabel">Search</h4>
                    </div>
                    <div class="modal-body">
                        <p>
                            From here you can search these documents. Enter
                            your search terms below.
                        </p>
                        <form role="form">
                            <div class="form-group">
                                <input type="text" class="form-control" placeholder="Search..." id="mkdocs-search-query">
                            </div>
                        </form>
                        <div id="mkdocs-search-results"></div>
                    </div>
                    <div class="modal-footer">
                    </div>
                </div>
            </div>
        </div>
    </body>
</html>